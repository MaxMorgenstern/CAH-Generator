<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>CAH Generator</title>
	<link rel="stylesheet" type="text/css" href="style/view.css" media="all">
	<script type="text/javascript" src="style/view.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script type="text/javascript">//<![CDATA[ 
		var TextQueue = [];
		var FileContent = "";
		var FileName = "";
		var CardColor = "";
		var OutputName = "";
		var StartDate = new Date();

		window.onload=function(){
			
			// POPULATE TEXT
			function wrapText(context, text, x, y, maxWidth, lineHeight) {
				var words = text.split(' ');
				var line = '';

				for(var n = 0; n < words.length; n++) {
					var testLine = line + words[n] + ' ';
					var metrics = context.measureText(testLine);
					var testWidth = metrics.width;
					if (testWidth > maxWidth && n > 0) {
						context.fillText(line, x, y);
						line = words[n] + ' ';
						y += lineHeight;
					} else {
						line = testLine;
					}
				}
				context.fillText(line, x, y);
			}

			// BUILD CANVAS
			function buildCanvas(mytext, myfile) {
				var canvas = document.getElementById('myCanvas');
				var context = canvas.getContext('2d');
				var canvasWidth = 3288;
				var canvasHeight = 4488;
				canvas.width = canvasWidth;
				canvas.height = canvasHeight;
				var maxWidth = 2400;
				var fontSize = 249;
				var lineHeight = Math.round(fontSize * 1.2);
				var x = (canvasWidth - maxWidth) / 2;
				var y = 690;
				var lengthWarning = 175;
				var text = mytext;
				var textColor = '#000000';
				var cardBackImage = 'white';

				if(text.length > lengthWarning) {
					log("Text might be too long: "+text);
				};

				if(text.length > 0) {
					if (CardColor == "black") {
						textColor = '#ffffff';
						cardBackImage = 'black' + cardType(text);
					};

					if (CardColor == "test") {
						textColor = '#ff0000';
						cardBackImage = 'card-template-transcard';
					}

					text = textClean(text);

					context.font = "bold "+fontSize+"px 'Helvetica Neue'";
					context.fillStyle = textColor;
					context.ineCap = "round";

					var backg = new Image();
					backg.src = "./img/"+cardBackImage+".png";

					backg.onload = function() {
						context.drawImage(backg, 0, 0);
						wrapText(context, text, x, y, maxWidth, lineHeight);
						var canvasData = canvas.toDataURL("image/png");

						$.ajax({
							type: "POST",
							url: "imageCreator.php",
							data: { data: canvasData, filename: myfile }
						})
						.done(function( msg ) {
							log( "Data Saved: " + msg + ".png" );
							triggerNext();
						});
					};
				} else {
					log( "No Data found. Skip.");
					triggerNext();
				}	
			};

			function textClean(str)
			{
				str = str.replace ('\“', '\"');
				str = str.replace ('\”', '\"');
				str = str.replace ('\’', '\'');
				str = str.replace ('[[2]]', '');
				str = str.replace ('[[3]]', '');
				str = str.replace ('[[G]]', '');
				str = str.replace ('[[g]]', '');
				str = str.trim();
				return str;
			}

			function cardType(str)
			{
				var mechanic = "-mechanic-";
				if(str.match(/[[2]]/gi)){ return mechanic+"p2"; }
				if(str.match(/[[3]]/gi)){ return mechanic+"d2p3"; }
				if(str.match(/[[G]]/gi)){ return mechanic+"gears"; }
				
				try {
					var blanks = str.match(/_+/gi).length;
					if (blanks == 2 ) {return mechanic+"p2"; }
					if (blanks == 3 ) {return mechanic+"d2p3"; }
				} catch (e) {
					console.log(e);
				}
				return "";
			}
			
			// TRIGGER NEXT
			function triggerNext()
			{
				if(TextQueue.length > 0)
				{
					/*
					var spent = new Date()-StartDate;
					var allItems = FileContent.length;
					var todoItems = TextQueue.length;
					var doneItems = allItems-todoItems;
					var secondsestimate = (spent/doneItems*todoItems)/1000;
					console.log(secondsestimate + " Seconds to go!");
					 */
					
					var i = TextQueue.pop();
					buildCanvas(i.txt, i.file);
				} else {
					log("Done!");
				}
			}

			// READ FILE
			function readTextFile(file)
			{
			    var rawFile = new XMLHttpRequest();
			    rawFile.open("GET", file, false);
			    rawFile.onreadystatechange = function ()
			    {
			        if(rawFile.readyState === 4)
			        {
			            if(rawFile.status === 200 || rawFile.status == 0)
			            {
			                var rfd = rawFile.responseText;
			                FileContent = rfd.split("\n");
			            }
			        }
			    }
			    rawFile.send(null);
			}

			function log(text){
				$('#consolearea').append(text + "\n"); 
				$('#consolearea').scrollTop($('#consolearea')[0].scrollHeight - $('#consolearea').height());
			}

			// ###################

			document.getElementById("saveForm").onclick = function () { 
				FileName = $( "#element_1" ).val();
				CardColor = $( "#element_3" ).val();
				OutputName = $( "#element_2" ).val();

				StartDate = new Date();
				log("Card creation started... \n" + StartDate);

				// read file
				if(FileName != "" && FileContent == ""){
					readTextFile(FileName);
					log("We read: " + FileContent.length + " Lines");
				} else {
					log("Uploaded file has: " + FileContent.length + " Lines");
				}
				// populate queue
				var fileLine = 0;
				FileContent.forEach(function(line) {
				    var tmpItm = { txt: line, file: OutputName+"_"+fileLine };
				    TextQueue.push(tmpItm);
				    fileLine++;
				});
				
				$("#consolelog").show();

				buildCanvas("Thanks for using my\n'Cards Against Humanity' Card Generator.\n - Max\n  www.porzelt.net", "_1 README");

				return false;
			};
		};//]]>  

		function fileSelected() {
			var input = document.getElementById('element_1_upload');
			
		    // Create a reader object
		    var reader = new FileReader();
		    if (input.files.length) {
		        var textFile = input.files[0];
		        reader.readAsText(textFile);
		        $(reader).on('load', processFile);
		    } else {
		        alert('Please upload a file before continuing')
		    } 
		}

		function processFile(e) {
		    var file = e.target.result,
		        results;
		    if (file && file.length) {
		        FileContent = file.split("\n");
		    	console.log("File Uploaded: " + FileContent.length + " lines.");
		    }
		}

	</script>
</head>
<body id="main_body" >
	<img id="top" src="style/top.png" alt="">
	<div id="form_container">
		<h1><a class="headlink" href="http://www.porzelt.net"></a></h1>
		<form id="form_967104" class="appnitro"  method="post" action="">
			<div class="form_description">
				<h2>CAH Generator</h2>
				<p>Cards Against Humanity custom card generator.</p>
			</div>						
			<ul >
				<li id="li_1" >
					<label class="description" for="element_1">Filename or select file</label>
					<div>
						<input id="element_1" name="element_1" class="element text medium" type="text" maxlength="255" />
						<br/><br/>
						<input type="file" name="element_1_upload" id="element_1_upload" onchange="fileSelected();" />
					</div>
					<p class="guidelines" id="guide_1"><small>Enter the name of the file.</small></p> 
				</li>
				<li id="li_3" >
					<label class="description" for="element_3">Card Color </label>
					<div>
						<select class="element select medium" id="element_3" name="element_3"> 
							<option value="white" selected="selected">White</option>
							<option value="black" >Black</option>
							<option value="test" >Test</option>
						</select>
					</div>
					<p class="guidelines" id="guide_3"><small>Select the color of the card you want to create</small></p> 
				</li>
				<li id="li_2" >
					<label class="description" for="element_2">Output Name </label>
					<div>
						<input id="element_2" name="element_2" class="element text medium" type="text" maxlength="255" value="CAH_Custom"/> 
					</div>
					<p class="guidelines" id="guide_2"><small>Prefix name of the output file</small></p> 
				</li>
				<li class="buttons">
				    <input type="hidden" name="form_id" value="967104" />
					<input id="saveForm" class="button_text" type="submit" name="submit" value="Submit" />
				</li>
			</ul>
			<div id="consolelog" class="consolelog" style="display:none">
				<textarea rows="10" id="consolearea" style=""></textarea>
			</div>
		</form>
	</div>
	<img id="bottom" src="style/bottom.png" alt="">
	<canvas class="canv" id="myCanvas" width=3288 height=4488></canvas>
	</body>
</html>